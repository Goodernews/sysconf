---
output:
  html_document: default
  pdf_document: default
---
```{r code = readLines("../load_data.R"), echo = F, cache = F, message = F}
```

```{r setup_demo_data, echo=FALSE, cache=FALSE, warning=FALSE, message=FALSE}
library(stringr)
library(readr)
library(ggplot2)
library(tidyr)
library(data.table)
library(tidyverse)
library(lubridate)
library(reshape2)
```

# Demographic Factors {#sec:demo}

Note: red == author, blue == PC for all plots

## Author Statistics
 * Country (time zone? language?)

```{r,echo=F, message=F, warning=F, cache=T}
#plots PC and author percents for Industry,Academia, Government, and NA w bar widths corresponding to totals

#has one row per paper or one role for pc position (with country)
people_tidy_countries <- countries %>%
  rename(country_name = country, country = code) %>%
  right_join(people_tidy)

people_countries <- people_tidy_countries %>%
  filter(role == "author" | role == "pc") %>%
  group_by(name, gs_email, country, role, region, subregion, timezone, sector, speaks_english) %>%
  summarize(gender = first(gender))

people_countries %>%
  filter(!is.na(gender), !is.na(country)) %>%
  group_by(country, role) %>%
  summarize(pct_w = 100 * sum(gender == "F") / n(), count = n()) %>%
  ggplot(aes(x = country, y = pct_w, fill = role)) +
    geom_col(position = "dodge2") +
    geom_text(aes(label = count), position = position_dodge(width = 0.9), vjust = -0.25) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ggtitle("Percent Women by Country") +
    xlab("Country") + ylab("Percent Women")

people_countries %>%
  filter(!is.na(gender), !is.na(country)) %>%
  group_by(country, role) %>%
  summarize(pct_w = 100 * sum(gender == "F") / n(), count = n()) %>%
  filter(count > 10) %>%
  ggplot(aes(x = country, y = pct_w, fill = role)) +
    geom_col(position = "dodge2") +
    geom_text(aes(label = count), position = position_dodge(width = 0.9), vjust = -0.25) +
    ggtitle("Percent Women by Country with count>10") +
    xlab("Country") + ylab("Percent Women")


```
Old Analysis: Norway and Taiwan have the highest author percentages, but with counts of only 20 and 17, respectively. France and Israel seem to have the only author percentages clearly higher than the US with substantial counts (which I'm judging to be around 50 kinda arbitrarily). The US has an overwhelming majority of both authors and PCS. US has more authors and more PCs than all the other countries combined for each role. Authors: 4058 US vs 2631 everywhere else. PCs: 1825 US vs 1466 everywhere else. (Note: this is only kinda true, because ~6000 people have a subregion and/or region but country is NA, so there are slightly more non-US authors than US authors when divided by region/subregion and about equal PCs) Germany and the UK both have substantial counts (279 and 236, respectively) with percentages closer to 5% than 10%. China, Hong Kong, and Sweden all have more female authors than PCs, CN with the most substantial counts of these.

```{r,echo=FALSE,message=FALSE}
#subregion plot
people_countries %>%
  filter(!is.na(gender), !is.na(subregion)) %>%
  group_by(subregion, role) %>%
  summarize(pct_w = 100 * sum(gender == "F") / n(),count = n()) %>%
  ggplot(aes(x = subregion, y = pct_w, fill = role)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    geom_col(position = "dodge2") +
    geom_text(aes(label = count), position = position_dodge(width = 0.9), vjust = -0.25)

#subregion plot with count > 2
people_countries %>%
  filter(!is.na(gender), !is.na(subregion)) %>%
  group_by(subregion, role) %>%
  summarize(pct_w = 100 * sum(gender == "F") / n(),count = n()) %>%
  filter(count > 2) %>%
  ggplot(aes(x = subregion, y = pct_w, fill = role)) +
    geom_col(position = "dodge2") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    geom_text(aes(label = count), position = position_dodge(width = 0.9), vjust = -0.25)
```
Old Analysis: Western Asia has the highest percentage of authors (~14%), Eastern Europe has 0 women among 40 authors, but has 4 women PCs out of 31. Only the grouping of Australia and New Zealand has more female authors than PCs, and with a very significant margin (~1.5% PCs and ~11 authors). Northern America, South America, and Southern Africa all have percentages a little above the overall average (~11.5% instead of 10.5%, but still pretty close).

```{r,echo=FALSE,message=FALSE}
people_countries %>%
  filter(!is.na(gender), !is.na(region)) %>%
  group_by(region, role) %>%
  summarize(pct_w = 100 * sum(gender == "F") / n(),count = n()) %>%
  ggplot(aes(x = region, y = pct_w, fill = role)) +
    geom_col(position = "dodge2") +
    geom_text(aes(label = count), position = position_dodge(width = 0.9), vjust = -0.25)
```
Old Analysis: Africa has the highest percentage of women authors, followed by the US. Everywhere except Oceania has more PCs than authors, but it's pretty small so this likely isn't meaningful. Asia has only a small gap between the percentage of authors and PCs, but they are both significantly lower than most other places.

Reproduce graph C from [huang19:historical]

#timezone plot
```{r, echo = F, message = F, warning=T}
people_countries %>%
  filter(!is.na(gender), !is.na(timezone)) %>%
  group_by(timezone, role) %>%
  summarize(pct_w = 100 * sum(gender == "F") / n(),count = n()) %>%
  ggplot(aes(x = timezone, y = pct_w, fill = role)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    geom_col(position = "dodge2") +
    geom_text(aes(label = count), position = position_dodge(width = 0.9), vjust = -0.25, angle = 90)
```

```{r, echo = F, message = F}
english_data <- people_countries %>%
  filter(!is.na(gender), !is.na(speaks_english)) %>%
  group_by(role,speaks_english)

english_table <- english_data %>%
  summarize(pct_w = round(100 * sum(gender == "F") / n(), 2))


knitr::kable(english_table, booktabs=TRUE, longtable=TRUE, align=c("r"), caption = "Percentage of women as author and PC who do and do not speak English")

#are these differences statistically significant?
people_countries %>%
  filter(role == "author", !is.na(gender), !is.na(speaks_english)) %>%
  group_by(gender) %>%
  summarize(english_speaking = sum(speaks_english), non_english = sum(!speaks_english)) %>%
  select(-1) %>%
  chisq.test() %>%
  report_chi()

people_countries %>%
  filter(role == "pc", !is.na(gender), !is.na(speaks_english)) %>%
  group_by(gender) %>%
  summarize(english_speaking = sum(speaks_english), non_english = sum(!speaks_english)) %>%
  select(-1) %>%
  chisq.test() %>%
  report_chi()

# They are for authors, not for PC!
```
Old Analysis: 11.2% of authors who speak English are women and 8.0% of authors who do not speak english are women. The diff in these means is 3.2 (p = 7.27e-06 or maybe <.0001 or something like that?). 18.7% of PCs who speak English are women and 15.7% of PCs who do not speak English are women (diff = 3 and p = 0.0215)

New analysis start: Women are slightly better represented in English-speaking countries. Is that because of the language or a developed-world thing in general? compare to country results.
This is probably further evidence of efforts at increased diversity where they can (elected roles like PC) vs. where they can't control (authors under peer review)

 ## Sector

Relevant quotes and stuff:

Charts from On the Compliance of Women Engineers with a Gendered Scientific System:

<!---![Female authors by sector and field](relevantsources/percentwomenbysectorandfield.png) -->


```{r, echo = F, message = F}
#creates barplot of percent women authors by sector
people_countries %>%
  filter(!is.na(gender), !is.na(sector)) %>%
  group_by(sector, role) %>%
  summarize(Women = 100 * sum(gender == "F") / n(), Men = 100 * sum(gender == "M") / n()) %>%
  melt(id.vars = c("sector", "role")) %>%
  rename(Gender = variable) %>%
  rename(Percent = value) %>%
  ggplot(aes(x = sector, y = Percent, fill = role)) +
    geom_col(position = "dodge2") +
    ggtitle("Percent by sector and gender") +
    xlab("Sector") +
    ylab("Percent") +
    facet_grid(. ~ Gender)
```
Lower % women in industry compared to other sectors: consistent with previous work (figure), so again, probably not a significant source of selection bias.
However, percentages in systems appear to be much lower than even Electric or Computer Engineering. Is that a real effect? why?

-------------

Table from Women, Gender, and Technology book:

<!---![Table of Percentage women engineers by sector](relevantsources/womenengineersbysector.png) -->


```{r, echo = F, message = F, warning = F}
people_tidy_countries %>%
  group_by(name, gs_email, role, sector) %>%
  filter(!is.na(gender), !is.na(sector)) %>%
  summarize(gender = first(gender)) %>%
  group_by(gender, role) %>%
  summarize(U = 100 * sum(sector == "EDU") / n(), G = 100 * sum(sector == "GOV") / n(), I = 100 * sum(sector == "COM") / n()) %>%
  melt(id.vars = c("gender", "role")) %>%
  rename(Sector = variable) %>%
  rename(Percent = value) %>%
    ggplot(aes(x = gender, y = Percent, fill = Sector)) +
    geom_bar(stat = "identity") +
    ggtitle("Percent by sector and gender") +
    xlab("Gender") +
    ylab("Percentage") +
    facet_grid(. ~ role)
```

Inconsistent with previous work: most of our authors are in academia; most of the  engineers in the table are in industry.
But we're focusing specifically on paper authors, which are more likely to come from academia because of the different incentive systems in academia and industry (find citation).
Other observations that should be looked into:
- No government or industry female pc chairs. Almost same for panelists. Opposite for session chairs.
- More women from academia than men from academia, relatively. Consistent with book's result.
- Similar authors from Gov across genders.
- What else do you see???


```{r, echo = F, message = F}
sector_table <- people_countries %>%
  filter(!is.na(gender)) %>%
  filter(role == "author" | role == "pc") %>%
  group_by(role) %>%
  filter(!is.na(sector)) %>%
  mutate(total_men = sum(gender == "M"), total_women = sum(gender=="F")) %>%
  select(role,gender, sector, total_women, total_men) %>%
  group_by(role,sector) %>%
  mutate(num_women = sum(gender == "F"), num_men = sum(gender == "M")) %>%
  mutate(percent_total_women = round(100 * num_women / total_women, 2), percent_total_men = round(100 * num_men / total_men, 2)) %>%
  select(role, sector, percent_total_women, percent_total_men)

sector_table <- sector_table[!duplicated(sector_table$percent_total_women),]

knitr::kable(t(sector_table), booktabs=TRUE, longtable=TRUE, align=c("r"), caption = "Percentage of all women (authors or PCs) in each sector")
```
Old Analysis: Overwhelming majority of authors and PCs from academia (prolly what the conference is geared towards/the sole goal of academic research so I think this makes sense). Highest discrepancy between author and PC percentages in government, but also smallest counts so less reliable. So many NAs possibly obscure the true breakdown of sector; maybe it's harder to determine whether someone is from either industry or gov than the other? Author percentages in industry and government are both lower than in academia? Do we have other statistics to compare to that? Why is gov PC percentage high than academia but industry isn't? (I don't have any good ideas right now for that). Why are the NA percentages better for both? Is is possibly harder to find the affiliations for women? Men seem to have pretty similar percentages of both authors and PCs across all sectors.

Should run chisq test on all pairs to measure significance of differences.

## Reputation

```{r hindex-distributions, echo = F, message = F, fig.cap="H-index distributions for PC members and authors"}
density_authors <- select(authors_with_profile, name, gender,hindex) %>%
mutate(role = ifelse(gender == "F", "f_author", "m_author"))

density_pcs <- select(pcs_with_profile, name, gender,hindex) %>% mutate(role = ifelse(gender == "F", "f_pc", "m_pc"))

density_data <- rbind(density_pcs,density_authors)

#density plot with author and pc!
ggplot(filter(density_data, !is.na(gender)), aes(x = hindex, colour = role)) +
  geom_density(position = "identity")
```

Old Analysis: PCS have generally higher hindex values than authors - unsuprising for a position of leadership I think. Not any clear differences in hindex between men and women in either role. Male PCS seem to have every so slightly higher values than women, but doesn't look like enough to be meaningful.

!!! Since this is a numeric variable, use t-test to show that there's no significance gender difference in authors (`r report_t(t.test(filter(authors, gender=="F")$hindex, filter(authors, gender=="M")$hindex))`), but there is in PC (`r report_t(t.test(filter(pcs, gender == "F")$hindex, filter(pcs, gender == "M")$hindex))`).

Relevant quotes and stuff:

"Women engineers publish their papers in journals with higher Impact Factors than their male peers, but their work receives lower recogis nition (fewer citations) from the scientific community." (from the abstract of On the Compliance of Women Engineers with a Gendered Scientific System)

!!!images go here too!

## Service Roles
* Same, but for PC members and other roles

## Conference Statistics
 * Same


## Faculty Diversity

* Look at which schools / departments have most female authors.
* Look at distinct authors, not papers.
* Limit to departments that produced at least 7 distinct authors, to ignore the noisy statistics from small numbers.
* Look at CS andfaculty, and if associated with CE or EE, include those as well.
* Look at approximate percentage of women across authors (in our set), in CS faculty (in Oct. 2019).
* Of those, also looking at approximate systems-specific faculty, based on research focus or several recent publications in our confs website.
* It's hard to generalize from few and approximate data points, but it suggests that...


```{r pct_by_school, cache = T}
by_school <- authors %>%
  filter(sector == "EDU", !is.na(gender)) %>%
  mutate(school = substring(str_replace(gs_email, pattern = "@([a-z]+\\.)?([a-z]+)\\.edu", replacement = "@\\2.edu"), 2)) %>%  # Merge different subdomains of same .edu school
  group_by(school) %>%
  summarize(women = sum(gender == "F"), men = sum(gender == "M"), pct_w = 100 * women / (women + men))

top_schools <- by_school %>%
  filter(men + women > 6) %>%
  arrange(desc(pct_w))

school_tbl <- data.frame(
  University = c("North Carolina (unc.edu)", "Princeton (princeton.edu)", "Boston (bu.edu)", "Delaware (udel.edu)", "Texas A&M (tamu.edu)", "Oregon (uoregon.edu)", "Arizona (arizona.edu)", "Imperial College (imperial.ac.uk)", "New South Wales (unsw.edu.au)", "Yale (yale.edu)"),
  f_authors = top_schools$women[1:10],
  m_authors = top_schools$men[1:10])
school_tbl$pct_w_authors <- paste0(round(100 * school_tbl$f_authors / (school_tbl$f_authors + school_tbl$m_authors), 1), "%") 

school_tbl$f_fac <- c(6, 16, 13, 12, 12, 7, 2, 17, NA, 6)
school_tbl$m_fac <- c(35, 59, 33, 32, 52, 24, 26, 54, NA, 18)
school_tbl$pct_w_fac <- paste0(round(100 * school_tbl$f_fac / (school_tbl$f_fac + school_tbl$m_fac), 1), "%")

school_tbl$f_sys <- c(3, 3, 2, 4, 4, 3, 2, 5, NA, 2)
school_tbl$m_sys <- c(10, 18, 9, 9, 16, 7, 9, 15, NA, 7)
school_tbl$pct_w_sys <- paste0(round(100 * school_tbl$f_sys / (school_tbl$f_sys + school_tbl$m_sys), 1), "%")

school_tbl$pct_sys <- paste0(round(100 * (school_tbl$f_sys + school_tbl$m_sys) / (school_tbl$f_fac + school_tbl$m_fac), 1), "%")
# No pattern emerges from this data?
```
